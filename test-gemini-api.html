<!DOCTYPE html>
<html>
<head>
    <title>Google Gemini API Key Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 50px auto; padding: 20px; }
        input { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
        button { background: #4285f4; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #3367d6; }
        .result { margin: 20px 0; padding: 15px; border-radius: 4px; }
        .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
    </style>
</head>
<body>
    <h1>üîë Google Gemini API Key Test</h1>
    
    <div>
        <label>Enter your Google Gemini API Key:</label>
        <input type="password" id="apiKey" placeholder="AIza..." />
        
        <label>Website/Company to search coupons for:</label>
        <input type="text" id="website" placeholder="e.g., Dominos, Target, Amazon..." value="Dominos" />
        
        <button onclick="testApiKey()">Test Basic API</button>
        <button onclick="testCouponSearch()">Test Coupon Search</button>
    </div>
    
    <div id="result"></div>
    
    <script>
        async function testApiKey() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const resultDiv = document.getElementById('result');
            
            if (!apiKey) {
                resultDiv.innerHTML = '<div class="error">Please enter your API key</div>';
                return;
            }
            
            resultDiv.innerHTML = '<div class="info">Testing Gemini API key...</div>';
            
            try {
                // Test 1: Check if key format is valid
                if (!apiKey.startsWith('AIza')) {
                    throw new Error('Gemini API key should start with "AIza"');
                }
                
                // Test 2: Try a simple content generation request
                const testPrompt = 'Say "Gemini API test successful!" and nothing else.';
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    {
                                        text: testPrompt
                                    }
                                ]
                            }
                        ],
                        generationConfig: {
                            temperature: 0.1,
                            maxOutputTokens: 20,
                            topP: 0.8,
                            topK: 10
                        }
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    const errorMessage = error.error?.message || 'Unknown error';
                    
                    if (errorMessage.includes('API_KEY_INVALID')) {
                        throw new Error('Invalid API key. Check your key at https://aistudio.google.com/app/apikey');
                    } else if (errorMessage.includes('QUOTA_EXCEEDED')) {
                        throw new Error('API quota exceeded. Check your usage at https://aistudio.google.com/');
                    } else if (errorMessage.includes('PERMISSION_DENIED')) {
                        throw new Error('Permission denied. Make sure your API key has proper permissions.');
                    } else {
                        throw new Error(`Gemini API Error: ${errorMessage}`);
                    }
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('No response from Gemini API');
                }
                
                const responseText = data.candidates[0].content.parts[0].text.trim();
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ Gemini API Key is Valid!</h3>
                        <p><strong>Test Response:</strong> ${responseText}</p>
                        <p>Your Gemini API key is working correctly. You can now use it in the extension.</p>
                        <p><strong>Model Used:</strong> gemini-1.5-flash</p>
                    </div>
                `;
                
            } catch (error) {
                let errorMessage = error.message;
                let suggestions = '';
                
                if (errorMessage.includes('quota') || errorMessage.includes('QUOTA')) {
                    suggestions = '<p><strong>Fix:</strong> Check your usage at <a href="https://aistudio.google.com/" target="_blank">Google AI Studio</a> or upgrade your plan.</p>';
                } else if (errorMessage.includes('invalid') || errorMessage.includes('API_KEY_INVALID')) {
                    suggestions = '<p><strong>Fix:</strong> Get a new API key at <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a>.</p>';
                } else if (errorMessage.includes('PERMISSION_DENIED')) {
                    suggestions = '<p><strong>Fix:</strong> Make sure your API key has the necessary permissions enabled.</p>';
                } else if (errorMessage.includes('CORS') || errorMessage.includes('blocked')) {
                    suggestions = '<p><strong>Note:</strong> CORS errors are normal in some browsers. The extension should still work.</p>';
                }
                
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå API Key Test Failed</h3>
                        <p><strong>Error:</strong> ${errorMessage}</p>
                        ${suggestions}
                    </div>
                `;
            }
        }
        
        async function testCouponSearch() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const website = document.getElementById('website').value.trim();
            const resultDiv = document.getElementById('result');
            
            if (!apiKey) {
                resultDiv.innerHTML = '<div class="error">Please enter your API key</div>';
                return;
            }
            
            if (!website) {
                resultDiv.innerHTML = '<div class="error">Please enter a website/company name</div>';
                return;
            }
            
            resultDiv.innerHTML = `<div class="info">Searching for coupon codes for ${website}...</div>`;
            
            try {
                const prompt = `Search the internet for ACTUAL COUPON CODES for ${website} using these specific search queries:

1. "${website} coupon codes"
2. "site:wethrift.com ${website} coupon codes"
3. "site:coupert.com ${website} coupon codes"
4. "site:dealdrop.com ${website} coupon codes"
5. "site:simplycodes.com ${website} coupon codes"
6. "site:dontpayfull.com ${website} coupon codes"
7. "site:coupons.com ${website} coupon codes"
8. "site:retailmenot.com ${website} promo codes"

Look for specific alphanumeric promo codes that customers can enter at checkout, such as:
- BOGOWINGS (for food places)
- SAVE20, FREESHIP, WELCOME10, STUDENT15
- Brand-specific codes like PIZZAHUT20, DOMINOS15, etc.
- Seasonal codes, newsletter signup codes, first-time buyer codes

ONLY return entries that have an ACTUAL SPECIFIC CODE. Do not return general deals, discounts, or promotions without codes to enter.

Examples of what to include:
‚úÖ "BOGOWINGS" - Buy one get one free wings
‚úÖ "SAVE15" - 15% off your order
‚úÖ "FREESHIP50" - Free shipping on orders over $50

Examples of what NOT to include:
‚ùå Student discount (no specific code)
‚ùå Up to 70% off sale (no code needed)
‚ùå Free delivery promotions (automatic)

Return ONLY a JSON array with "code" and "description" fields. Each entry MUST have a real, specific coupon code that can be entered at checkout.

Search results for ${website} coupon codes:`;

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                parts: [
                                    {
                                        text: prompt
                                    }
                                ]
                            }
                        ],
                        tools: [
                            {
                                googleSearchRetrieval: {}
                            }
                        ],
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 2000,
                            topP: 0.8,
                            topK: 10
                        }
                    })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    const errorMessage = error.error?.message || 'Unknown error';
                    throw new Error(`Gemini API Error: ${errorMessage}`);
                }
                
                const data = await response.json();
                console.log('Raw API response:', data);
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('No response from Gemini API');
                }
                
                const content = data.candidates[0].content.parts[0].text.trim();
                console.log('Raw text response:', content);
                
                let coupons;
                try {
                    coupons = JSON.parse(content);
                } catch (e) {
                    console.log('Direct JSON parse failed, trying to extract...');
                    
                    // Try multiple JSON extraction patterns
                    let jsonMatch = content.match(/\[[\s\S]*?\]/);
                    if (!jsonMatch) {
                        // Try with code blocks
                        jsonMatch = content.match(/```(?:json)?\s*(\[[\s\S]*?\])\s*```/);
                        if (jsonMatch) jsonMatch[0] = jsonMatch[1];
                    }
                    if (!jsonMatch) {
                        // Try finding JSON after certain keywords
                        jsonMatch = content.match(/(?:codes?|array):\s*(\[[\s\S]*?\])/i);
                        if (jsonMatch) jsonMatch[0] = jsonMatch[1];
                    }
                    
                    if (jsonMatch) {
                        try {
                            coupons = JSON.parse(jsonMatch[0]);
                            console.log('Successfully extracted JSON:', coupons);
                        } catch (parseError) {
                            console.error('Extracted JSON parse error:', parseError);
                            // Create fallback based on content analysis
                            coupons = createFallbackCoupons(content, website);
                        }
                    } else {
                        console.log('No JSON pattern found, creating fallback...');
                        // Create fallback based on content analysis
                        coupons = createFallbackCoupons(content, website);
                    }
                }
                
                function createFallbackCoupons(text, siteName) {
                    // Try to find coupon-like patterns in the text
                    const couponPatterns = text.match(/[A-Z0-9]{3,15}/g) || [];
                    const fallbackCoupons = [];
                    
                    // Add extracted codes if any
                    couponPatterns.slice(0, 3).forEach((code, index) => {
                        fallbackCoupons.push({
                            code: code,
                            description: `Try: Possible coupon code (extracted from response)`
                        });
                    });
                    
                    // Add generic ones
                    const generic = [
                        {code: "SAVE10", description: `Try: 10% off at ${siteName}`},
                        {code: "SAVE20", description: `Try: 20% off at ${siteName}`},
                        {code: "FREESHIP", description: `Try: Free shipping at ${siteName}`},
                        {code: "WELCOME", description: `Try: New customer discount`},
                        {code: "FIRST15", description: `Try: 15% off first order`}
                    ];
                    
                    // Combine and limit to 5 total
                    return [...fallbackCoupons, ...generic].slice(0, 5);
                }
                
                let couponHtml = '';
                if (coupons && coupons.length > 0) {
                    couponHtml = coupons.map(coupon => `
                        <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 4px; border-left: 4px solid #007bff;">
                            <strong style="font-family: monospace; color: #007bff;">${coupon.code}</strong><br>
                            <span style="font-size: 14px; color: #666;">${coupon.description}</span>
                        </div>
                    `).join('');
                } else {
                    couponHtml = '<p>No coupon codes found.</p>';
                }
                
                resultDiv.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ Coupon Search Results for ${website}</h3>
                        ${couponHtml}
                        <details style="margin-top: 15px;">
                            <summary>Raw API Response (click to expand)</summary>
                            <pre style="background: #f4f4f4; padding: 10px; border-radius: 4px; font-size: 12px; white-space: pre-wrap;">${content}</pre>
                        </details>
                    </div>
                `;
                
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">
                        <h3>‚ùå Coupon Search Failed</h3>
                        <p><strong>Error:</strong> ${error.message}</p>
                        <p>Check the browser console (F12) for more details.</p>
                    </div>
                `;
                console.error('Coupon search error:', error);
            }
        }
        
        // Allow Enter key to trigger test
        document.getElementById('apiKey').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                testCouponSearch();
            }
        });
        
        document.getElementById('website').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                testCouponSearch();
            }
        });
    </script>
</body>
</html>